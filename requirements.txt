import asyncio
import logging
import os
import re
from datetime import date
from typing import List, Dict, Any

import aiosqlite
from aiogram import Bot, Dispatcher
from aiogram.filters import CommandStart, Command
from aiogram.types import Message
from dotenv import load_dotenv

load_dotenv()
logging.basicConfig(level=logging.INFO)

TOKEN = os.getenv("BOT_TOKEN")
if not TOKEN:
    print("–û—à–∏–±–∫–∞: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env!")
    exit(1)

bot = Bot(token=TOKEN)
dp = Dispatcher()

DB_PATH = "workouts.db"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã
async def init_db():
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("""
            CREATE TABLE IF NOT EXISTS workouts (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                date TEXT NOT NULL,
                exercise TEXT NOT NULL,
                sets INTEGER,
                reps TEXT,
                weight REAL,
                created_at TEXT DEFAULT CURRENT_TIMESTAMP
            )
        """)
        await db.commit()
    print("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")

# –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä (—Ä—É—Å—Å–∫–∏–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã)
def parse_exercise_line(line: str) -> List[Dict[str, Any]]:
    line = line.strip().lower()
    if not line:
        return []

    # –ü–∞—Ç—Ç–µ—Ä–Ω: —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ [sets]x[reps] [weight][–∫–≥]
    pattern = r'^([–∞-—èa-z—ë\s\-]+?)\s*(?:(\d+)\s*[x—Ö]\s*([\d\-]+|max|–¥–æ\s*–æ—Ç–∫–∞–∑–∞))?\s*([\d,.]+)?\s*(–∫–≥|kg|–∫)?$'
    match = re.match(pattern, line)

    if match:
        exercise = match.group(1).strip().title()
        sets = int(match.group(2)) if match.group(2) else None
        reps = match.group(3) if match.group(3) else None
        weight = float(match.group(4).replace(',', '.')) if match.group(4) else None
        return [{"exercise": exercise, "sets": sets, "reps": reps, "weight": weight}]

    # –ü—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –ø—Ä–æ—Å—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ + –≤–µ—Å
    simple = r'^([–∞-—èa-z—ë\s\-]+?)\s*([\d,.]+)?\s*(–∫–≥|kg|–∫)?$'
    simple_match = re.match(simple, line)
    if simple_match:
        exercise = simple_match.group(1).strip().title()
        weight = float(simple_match.group(2).replace(',', '.')) if simple_match.group(2) else None
        return [{"exercise": exercise, "weight": weight}]

    return []

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
async def save_workout(user_id: int, text: str):
    today = date.today().isoformat()
    exercises = []

    for line in text.split('\n'):
        parsed = parse_exercise_line(line)
        exercises.extend(parsed)

    if not exercises:
        return False, "–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ üòî\n–ü—Ä–∏–º–µ—Ä: –ñ–∏–º –ª–µ–∂–∞ 3x8 75–∫–≥"

    async with aiosqlite.connect(DB_PATH) as db:
        for ex in exercises:
            await db.execute("""
                INSERT INTO workouts (user_id, date, exercise, sets, reps, weight)
                VALUES (?, ?, ?, ?, ?, ?)
            """, (user_id, today, ex["exercise"], ex["sets"], ex["reps"], ex["weight"]))
        await db.commit()

    return True, f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(exercises)} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∑–∞ {today} ‚úÖ"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
async def get_stats(user_id: int) -> str:
    async with aiosqlite.connect(DB_PATH) as db:
        cursor = await db.execute("""
            SELECT exercise, SUM(sets * COALESCE(weight, 0)) as volume,
                   MAX(weight) as max_weight, COUNT(*) as count
            FROM workouts
            WHERE user_id = ?
            GROUP BY exercise
            ORDER BY volume DESC
            LIMIT 10
        """, (user_id,))
        rows = await cursor.fetchall()

    if not rows:
        return "–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π. –î–æ–±–∞–≤—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!"

    lines = ["üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"]
    for ex, vol, maxw, cnt in rows:
        lines.append(f"‚Ä¢ {ex}: –æ–±—ä—ë–º {vol:.0f} –∫–≥ ‚Ä¢ –º–∞–∫—Å {maxw or '?'} –∫–≥ ‚Ä¢ {cnt} —Ä–∞–∑")
    return "\n".join(lines)

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
async def get_progress(user_id: int) -> str:
    async with aiosqlite.connect(DB_PATH) as db:
        cursor = await db.execute("""
            SELECT date, exercise, sets, reps, weight
            FROM workouts
            WHERE user_id = ?
            ORDER BY date DESC, id DESC
            LIMIT 20
        """, (user_id,))
        rows = await cursor.fetchall()

    if not rows:
        return "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"

    text = "üìà –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:\n"
    for d, ex, s, r, w in rows:
        line = f"{d} ‚Ä¢ {ex}"
        if s: line += f" {s}x"
        if r: line += r
        if w: line += f" {w}–∫–≥"
        text += line + "\n"
    return text

# –•–µ–Ω–¥–ª–µ—Ä—ã
@dp.message(CommandStart())
async def start(message: Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç! üí™\n–ü–∏—à–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã:\n/stats ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n/progress ‚Äî –∏—Å—Ç–æ—Ä–∏—è")

@dp.message(Command("stats"))
async def stats(message: Message):
    text = await get_stats(message.from_user.id)
    await message.answer(text)

@dp.message(Command("progress"))
async def progress(message: Message):
    text = await get_progress(message.from_user.id)
    await message.answer(text)

@dp.message()
async def any_message(message: Message):
    success, resp = await save_workout(message.from_user.id, message.text)
    await message.answer(resp + ("\n\n/stats –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏" if success else ""))

async def main():
    await init_db()
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
aiogram==3.13.1
python-dotenv
aiosqlite
